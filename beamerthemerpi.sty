\mode<presentation>

% main references:
% basics
% https://tex.stackexchange.com/questions/146529/design-a-custom-beamer-theme-from-scratch
% tikz stuff
% https://tex.stackexchange.com/questions/395530/make-tikz-nodes-flush-with-slide-edges-in-beamer-title-slide

% Requirement
\usepackage{tikz}
\usetikzlibrary{calc}

\usepackage[most]{tcolorbox}
\usepackage{changepage}
\usepackage{listings}

% NOTE: uncomment if you want the navigations
\setbeamertemplate{navigation symbols}{}

\setbeamertemplate{blocks}[rounded][shadow=true]

% font
\usepackage{fontspec}
\setsansfont{Arial}

%----------------------------------------------------------------------------------------
% Custom fonts
%----------------------------------------------------------------------------------------
\setbeamerfont{title}{size=\huge,series=\bfseries,parent=structure}
\setbeamerfont{subtitle}{size=\scriptsize,series=\bfseries,parent=structure}
\setbeamerfont{author}{size=\scriptsize,parent=structure}
\setbeamerfont{institute}{size=\scriptsize,parent=structure}
\setbeamerfont{date}{size=\scriptsize,parent=structure}
\setbeamerfont{frametitle}{size=\Large,parent=structure}
\setbeamerfont{framesubtitle}{size=\normalsize,parent=structure}
\setbeamerfont{framefooter}{size=\tiny,parent=structure}
\setbeamerfont{framefootertitle}{size=\footnotesize, series=\bfseries,parent=structure}

%----------------------------------------------------------------------------------------
% RPI Colors
%----------------------------------------------------------------------------------------
\definecolor{RPIred}{RGB}{214,0,28} % RPI Red (primary)
\definecolor{RPIdarkgray}{RGB}{84, 88, 90} % RPI Dark Gray (secondary)
\definecolor{RPIlightgray}{RGB}{158, 162, 162} % UBC Grey (secondary)

\setbeamercolor{palette primary}{bg=RPIred,fg=white}
\setbeamercolor{palette secondary}{bg=RPIred,fg=white}
\setbeamercolor{palette tertiary}{bg=RPIred,fg=white}
\setbeamercolor{palette quaternary}{bg=RPIred,fg=white}
\setbeamercolor{structure}{fg=RPIred} % itemize, enumerate, etc
\setbeamercolor{section in toc}{fg=RPIred} % TOC sections
\setbeamercolor{subsection in head/foot}{bg=RPIdarkgray,fg=white}
\setbeamercolor{author}{fg=white}
\setbeamercolor{title}{fg=white}
\setbeamercolor{frametitle}{fg=RPIdarkgray}
\setbeamercolor{framesubtitle}{fg=RPIlightgray}
\setbeamercolor{framefooter}{fg=white}

%----------------------------------------------------------------------------------------
% Page margins
%----------------------------------------------------------------------------------------
\setbeamersize{
  text margin left=0.02\paperwidth,
  text margin right=0.02\paperwidth,
  % text margin top=0.02\paperheight,
}
% this adds to the top margin
% \addtolength{\headsep}{0.1\paperheight}

%----------------------------------------------------------------------------------------
% Title page
%----------------------------------------------------------------------------------------
\defbeamertemplate*{title page}{rpi}[1][]
{
  \begin{tikzpicture}[remember picture, overlay]
    \node
    at ($(current page.north) + (-0.25\paperwidth,-0.22\paperheight)$)
    % ([xshift=0.07\paperwidth, yshift=-0.1\paperheight]current page.north west)
    {\includegraphics[height=0.17\paperheight]{./logos/Rensselaer-Large-Logo-with-Tagline-CMYK-TwoColor.png}};
    \fill[color=RPIred] (current page.west)rectangle(current page.south east);
    \node[
      % text centered,
      text width=0.95\paperwidth,
      % text depth=1.15\paperheight,
      % text height=0.15\paperheight,
      % draw=green,
    ]
    at ($(current page.south) + (0, 0.3\paperheight)$)
    {
    \usebeamercolor[fg]{title}\usebeamerfont{title}\inserttitle 
    \vfill
    };

    \node[text width=0.95\paperwidth, align=left]
    at ($(current page.south) + (0, 0.05\paperheight)$)
    {
    \usebeamercolor[fg]{author}\usebeamerfont{author}\insertauthor%
    ~|~\usebeamercolor[fg]{author}\usebeamerfont{author}\insertinstitute%
    \hfill|\hfill
    \usebeamercolor[fg]{author}\usebeamerfont{author}\insertdate%
    };
  \end{tikzpicture}
}

%----------------------------------------------------------------------------------------
% Frame title
%----------------------------------------------------------------------------------------
\defbeamertemplate*{frametitle}{rpi}[1][]
{
  % NOTE: this is following the official powerpoint template. You can uncomment the other one to use a filled red box if you don't like this.
  % If you do that, make sure the change the frametitle and framesubtitle font colors to white as well.
  \begin{tikzpicture}[remember picture, overlay]

  % NOTE: use this if you want thick borders
  \draw[draw=RPIred, thick]($(current page.north west)+(0,-0.15\paperheight)$)
  -- ($(current page.north east)+(0,-0.15\paperheight)$);

  % use this if you want a red background
  % \fill[color=RPIred] (current page.north west)rectangle($(current page.north east) + (0, -0.15\paperheight)$);
  \ifx\insertframesubtitle\@empty%
    {
    \node[text width=0.95\paperwidth, align=left]
    at ($(current page.north)+(0,-0.08\paperheight)$)
    { \usebeamercolor[fg]{slidetitle}\usebeamerfont{slidetitle}\insertframetitle };
    }
    \else%
    {
      \node[text width=0.95\paperwidth, align=left]
      at ($(current page.north)+(0,-0.05\paperheight)$)
      { \usebeamercolor[fg]{frametitle}\usebeamerfont{frametitle}\insertframetitle };
      \node[text width=0.95\paperwidth, align=left]
      at ($(current page.north)+(0,-0.11\paperheight)$)
      { \usebeamercolor[fg]{framesubtitle}\usebeamerfont{framesubtitle}\insertframesubtitle };
    }%
    \fi
  \end{tikzpicture}
  \vspace{0.1\paperheight}
  % \end{beamercolorbox}
}

\setbeamertemplate{footline}{
  \vspace{0.1\paperheight}
  \begin{tikzpicture}[remember picture, overlay]
    % red background for footer
    \fill[color=RPIred] (current page.south west)rectangle($(current page.south east) + (0, 0.1\paperheight)$);
    % white logo
    \node 
    at ($(current page.south) + (-0.4\paperwidth,0.05\paperheight)$)
    {\includegraphics[height=0.06\paperheight]{./logos/Rensselaer-Large-Logo-RGB-White.png}};
    % shorttitle 
    % NOTE: Centering makes gaps too wide so I used spaceskip. Wonder if there is a tikz native way to do this.
    \node[text width=0.95\paperwidth, align=center]
    at ($(current page.south)+(0,0.05\paperheight)$)
    {\spaceskip=2pt \usebeamercolor[fg]{framefooter}\usebeamerfont{framefooter}\insertshorttitle };
    % page number
    \node[text width=0.95\paperwidth, align=right]
    at ($(current page.south)+(0,0.062\paperheight)$)
    { \usebeamercolor[fg]{framefooter}\usebeamerfont{framefooter}\insertpagenumber };
    % date
    \node[text width=0.95\paperwidth, align=right]
    at ($(current page.south)+(0,0.033\paperheight)$)
    { \usebeamercolor[fg]{framefooter}\usebeamerfont{framefooter}\insertdate };
  \end{tikzpicture}

}

%----------------------------------------------------------------------------------------
% Items (Lists)
%----------------------------------------------------------------------------------------
\setbeamertemplate{items}[square]
\setbeamertemplate{enumerate items}[default]
\setbeamertemplate{sections/subsections in toc}[square]

%----------------------------------------------------------------------------------------
% Textblock
%----------------------------------------------------------------------------------------
\newtcolorbox[auto counter]{primaryblock}[2][]{
  enhanced,
  breakable,
  % boxsep=1pt,
  left=4pt,
  right=4pt,
  top=4pt,
  bottom=4pt,
  fonttitle=\scshape,
  colback=white,
  colbacktitle=RPIred,
  colframe=RPIred,
  % title=Example~\thetcbcounter: #2,
  title=#2,
  #1,
}
\newtcolorbox[auto counter]{secondaryblock}[2][]{
  enhanced,
  breakable,
  % boxsep=1pt,
  left=4pt,
  right=4pt,
  top=4pt,
  bottom=4pt,
  fonttitle=\scshape,
  colback=white,
  colbacktitle=RPIdarkgray,
  colframe=RPIdarkgray,
  % title=Example~\thetcbcounter: #2,
  title=#2,
  #1,
}

%----------------------------------------------------------------------------------------
% Trick for beamer two-column TOC
% https://tex.stackexchange.com/questions/462341/beamer-table-of-contents-overly
%----------------------------------------------------------------------------------------
\newcommand{\advanceslidecounter}[1]{%
  \advance\beamer@slideinframe by #1 %
}%

\newcommand{\slideinframe}{\the\beamer@slideinframe}
\newcounter{tocseccounter}

\mode<all>
